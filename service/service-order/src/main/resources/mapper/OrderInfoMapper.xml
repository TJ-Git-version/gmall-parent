<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper SYSTEM "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.atguigu.gmall.order.mapper.OrderInfoMapper">

    <!--连表实现-->

<!--    <resultMap id="orderInfoDetailMap" type="com.atguigu.gmall.model.order.OrderInfo" autoMapping="true">-->
<!--        <id property="id" column="id"/>-->
<!--        <collection property="orderDetailList" ofType="com.atguigu.gmall.model.order.OrderDetail" autoMapping="true">-->
<!--            <id property="id" column="order_detail_id"/>-->
<!--        </collection>-->
<!--    </resultMap>-->

<!--    &lt;!&ndash;关联查询订单信息和订单详情&ndash;&gt;-->
<!--    <sql id="orderInfoDetailSql">-->
<!--        select oi.id,-->
<!--               oi.consignee,-->
<!--               oi.consignee_tel,-->
<!--               oi.total_amount,-->
<!--               oi.order_status,-->
<!--               oi.user_id,-->
<!--               oi.payment_way,-->
<!--               oi.delivery_address,-->
<!--               oi.order_comment,-->
<!--               oi.out_trade_no,-->
<!--               oi.trade_body,-->
<!--               oi.operate_time,-->
<!--               oi.expire_time,-->
<!--               oi.process_status,-->
<!--               oi.create_time,-->
<!--               oi.update_time,-->
<!--               od.id order_detail_id,-->
<!--               od.order_id,-->
<!--               od.sku_id,-->
<!--               od.sku_name,-->
<!--               od.img_url,-->
<!--               od.order_price,-->
<!--               od.sku_num,-->
<!--               od.source_type,-->
<!--               od.source_id,-->
<!--               od.split_total_amount,-->
<!--               od.split_activity_amount,-->
<!--               od.split_coupon_amount,-->
<!--               od.create_time,-->
<!--               od.update_time,-->
<!--               od.is_deleted-->
<!--        from order_info oi-->
<!--                 inner join order_detail od-->
<!--                            on oi.id = od.order_id-->
<!--    </sql>-->

<!--    <select id="selectPageByUserId" resultMap="orderInfoDetailMap">-->
<!--        <include refid="orderInfoDetailSql"></include>-->
<!--        where oi.user_id = #{userId}-->
<!--          and oi.order_status not in ('CLOSED', 'SPLIT')-->
<!--        order by order_price desc-->
<!--    </select>-->

    <!--子查询实现-->

    <resultMap id="orderInfoDetailMap" type="com.atguigu.gmall.model.order.OrderInfo" autoMapping="true">
        <id property="id" column="id"/>
        <collection property="orderDetailList"
                    autoMapping="true"
                    ofType="com.atguigu.gmall.model.order.OrderDetail"
                    column="{orderId = id}"
                    select="selectOrderDetailByOrderId">
        </collection>
    </resultMap>

    <sql id="orderInfoSql">
        select id,
               consignee,
               consignee_tel,
               total_amount,
               order_status,
               user_id,
               payment_way,
               delivery_address,
               order_comment,
               out_trade_no,
               trade_body,
               operate_time,
               expire_time,
               process_status,
               create_time,
               update_time
        from order_info
    </sql>

    <select id="selectOrderInfoByUserId" resultMap="orderInfoDetailMap">
        <include refid="orderInfoSql"></include>
        where user_id = #{userId}
        order by create_time desc
    </select>

    <sql id="orderDetailSql">
        select id,
               order_id,
               sku_id,
               sku_name,
               img_url,
               order_price,
               sku_num,
               source_type,
               source_id,
               split_total_amount,
               split_activity_amount,
               split_coupon_amount,
               create_time,
               update_time
        from order_detail
    </sql>


    <select id="selectOrderDetailByOrderId" resultType="com.atguigu.gmall.model.order.OrderDetail">
        <include refid="orderDetailSql"></include>
        where order_id = #{orderId}
        order by create_time desc
    </select>
</mapper>